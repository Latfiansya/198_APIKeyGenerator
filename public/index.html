<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate API Key</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="card">
        
        <div class="top-action">
            <a href="/checkApi">Cek API &rarr;</a>
        </div>

        <h1>Praktikum PWS</h1>
        <p style="text-align: center;">Generate your access key below</p>

        <label>API Key Generated</label>
        <div class="api-key-wrapper">
            <div id="apiKeyText" class="api-key-display">Click generate below...</div>
            
            <button id="copyBtn" class="copy-btn-icon" title="Copy to Clipboard">
                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
        </div>

        <button id="generateBtn">Generate New API Key</button>
        <p id="message" style="text-align:center; margin-top:10px; font-size:13px; min-height:20px;"></p>

        <hr>

        <h2>User Profile</h2>
        <p style="text-align: center; margin-bottom: 20px;">Save your details to activate the key</p>

        <form id="userForm">
            <label>First Name</label>
            <input id="firstName" type="text" placeholder="John">

            <label>Last Name</label>
            <input id="lastName" type="text" placeholder="Appleseed">

            <label>Email Address</label>
            <input id="email" type="email" placeholder="john@icloud.com">

            <button id="saveBtn" type="button" disabled>Save User Data</button>
        </form>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const apiKeyText = document.getElementById('apiKeyText');
        const copyBtn = document.getElementById('copyBtn');
        const message = document.getElementById('message');

        let currentApiKey = null;

        generateBtn.addEventListener('click', async () => {
            try {
                // Efek loading
                generateBtn.textContent = "Generating...";
                generateBtn.disabled = true;

                const res = await fetch('/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await res.json();
                generateBtn.textContent = "Generate New API Key";
                generateBtn.disabled = false;

                if (!data.success) {
                    message.textContent = data.message;
                    message.style.color = "red";
                    return;
                }

                currentApiKey = data.apiKey;
                apiKeyText.textContent = currentApiKey;
                apiKeyText.style.color = "#1d1d1f"; // Make text darker indicating active

                saveBtn.disabled = false;
                message.textContent = data.message;
                message.style.color = "green";

            } catch (err) {
                generateBtn.textContent = "Generate New API Key";
                generateBtn.disabled = false;
                alert('Gagal generate API key.');
            }
        });

        copyBtn.addEventListener('click', async () => {
            if (!currentApiKey) return;
            await navigator.clipboard.writeText(currentApiKey);
            
            // Visual feedback kecil
            const originalIcon = copyBtn.innerHTML;
            copyBtn.innerHTML = `<svg viewBox="0 0 24 24"><path fill="#34C759" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
            setTimeout(() => {
                copyBtn.innerHTML = originalIcon;
            }, 2000);
        });

        saveBtn.addEventListener('click', async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!firstName || !lastName || !email) {
                alert('Semua field harus diisi.');
                return;
            }

            const res = await fetch('/user/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    firstName,
                    lastName,
                    email,
                    apiKey: currentApiKey
                })
            });

            const data = await res.json();

            if (!data.success) {
                alert(data.message);
                return;
            }

            alert("User berhasil disimpan!");
        });
    </script>
</body>
</html>