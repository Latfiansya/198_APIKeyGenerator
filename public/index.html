<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generate API Key</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: radial-gradient(circle at 20% 20%, #1e1e2f, #111);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }
    .code-box {
      background: #1e1e2f;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
  <div class="glass rounded-2xl p-8 w-full max-w-md text-center relative">

    <h1 class="text-2xl font-bold mb-3">Generate API Key</h1>

    <div class="copy-container relative mb-4">
      <div id="apiKeyBox" class="code-box">
        <span id="apiKeyText" class="text-gray-400 italic">Belum ada API key</span>
      </div>
      <button id="copyBtn" class="copy-btn absolute top-3 right-3">Copy</button>
    </div>

    <button id="generateBtn"
      class="btn mt-2 w-full py-2 rounded-lg font-semibold text-white shadow-md">
      Generate API Key
    </button>

    <p id="message" class="mt-4 text-sm opacity-0 transition-all duration-500"></p>

    <!-- FORM USER -->
    <div class="mt-8 text-left space-y-4">

      <div>
        <label>First Name</label>
        <input id="firstName" class="w-full bg-gray-800 px-3 py-2 rounded mt-1" type="text">
      </div>

      <div>
        <label>Last Name</label>
        <input id="lastName" class="w-full bg-gray-800 px-3 py-2 rounded mt-1" type="text">
      </div>

      <div>
        <label>Email</label>
        <input id="email" class="w-full bg-gray-800 px-3 py-2 rounded mt-1" type="email">
      </div>

      <button id="saveBtn"
        class="btn mt-4 w-full py-2 rounded-lg font-semibold text-white shadow-md opacity-50 cursor-not-allowed"
        disabled>
        Save User
      </button>

    </div>
  </div>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const apiKeyText = document.getElementById('apiKeyText');
    const copyBtn = document.getElementById('copyBtn');
    const message = document.getElementById('message');

    let currentApiKey = null;

    // =============================
    // 1. Generate API KEY via backend
    // =============================
    generateBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await res.json();
        if (!data.success) {
          alert(data.message);
          return;
        }

        currentApiKey = data.apiKey;

        apiKeyText.textContent = currentApiKey;
        apiKeyText.classList.remove('text-gray-400', 'italic');

        // enable SAVE button
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');

        message.textContent = data.message;
        message.style.opacity = 1;
      } catch (err) {
        alert('Gagal generate API key.');
      }
    });

    // =============================
    // 2. Copy ke clipboard
    // =============================
    copyBtn.addEventListener('click', async () => {
      if (!currentApiKey) return;
      await navigator.clipboard.writeText(currentApiKey);
      alert('Copied!');
    });

    // =============================
    // 3. Save user
    // =============================
    saveBtn.addEventListener('click', async () => {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!firstName || !lastName || !email) {
        alert('Semua field harus diisi.');
        return;
      }

      const res = await fetch('/user/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          firstName,
          lastName,
          email,
          apiKey: currentApiKey
        })
      });

      const data = await res.json();

      if (!data.success) {
        alert(data.message);
        return;
      }

      alert("User berhasil disimpan!");
    });

  </script>

</body>
</html>
