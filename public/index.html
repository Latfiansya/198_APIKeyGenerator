<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate API Key</title>
</head>

<body>

    <!-- Tombol cek API di pojok kanan atas -->
    <div style="position: absolute; top: 10px; right: 10px;">
        <a href="/checkApi" id="cekApiBtn">Cek API</a>
    </div>

    <h1>Generate API Key</h1>

    <div>
        <p>API Key:</p>
        <pre id="apiKeyText">Belum ada API key</pre>
        <button id="copyBtn">Copy</button>
    </div>

    <button id="generateBtn">Generate API Key</button>

    <p id="message"></p>

    <hr>

    <h2>Data User</h2>

    <label>First Name</label><br>
    <input id="firstName" type="text"><br><br>

    <label>Last Name</label><br>
    <input id="lastName" type="text"><br><br>

    <label>Email</label><br>
    <input id="email" type="email"><br><br>

    <button id="saveBtn" disabled>Save User</button>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const apiKeyText = document.getElementById('apiKeyText');
        const copyBtn = document.getElementById('copyBtn');
        const message = document.getElementById('message');

        let currentApiKey = null;

        // 1. Generate API KEY dari backend
        generateBtn.addEventListener('click', async () => {
            try {
                const res = await fetch('/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await res.json();
                if (!data.success) {
                    alert(data.message);
                    return;
                }

                currentApiKey = data.apiKey;
                apiKeyText.textContent = currentApiKey;

                saveBtn.disabled = false;

                message.textContent = data.message;
            } catch (err) {
                alert('Gagal generate API key.');
            }
        });

        // 2. Copy ke clipboard
        copyBtn.addEventListener('click', async () => {
            if (!currentApiKey) return;
            await navigator.clipboard.writeText(currentApiKey);
            alert('Copied!');
        });

        // 3. Save user
        saveBtn.addEventListener('click', async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!firstName || !lastName || !email) {
                alert('Semua field harus diisi.');
                return;
            }

            const res = await fetch('/user/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    firstName,
                    lastName,
                    email,
                    apiKey: currentApiKey
                })
            });

            const data = await res.json();

            if (!data.success) {
                alert(data.message);
                return;
            }

            alert("User berhasil disimpan!");
        });

    </script>

</body>
</html>
